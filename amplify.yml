version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - |
          if [ -z "$VITE_API_URL" ] || [ -z "$VITE_AWS_REGION" ] || [ -z "$VITE_AWS_USER_POOL_ID" ] || [ -z "$VITE_AWS_USER_POOL_CLIENT_ID" ]; then
            echo "ERRO: Variáveis de ambiente obrigatórias não configuradas"
            echo "Configure no AWS Amplify Console: Environment variables"
            exit 1
          fi
        - echo "VITE_API_URL=$VITE_API_URL" >> .env.production
        - echo "VITE_AWS_REGION=$VITE_AWS_REGION" >> .env.production
        - echo "VITE_AWS_USER_POOL_ID=$VITE_AWS_USER_POOL_ID" >> .env.production
        - echo "VITE_AWS_USER_POOL_CLIENT_ID=$VITE_AWS_USER_POOL_CLIENT_ID" >> .env.production
        - echo "VITE_ENV=production" >> .env.production
        - echo "NODE_ENV=production" >> .env.production
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains; preload'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
      - key: 'Referrer-Policy'
        value: 'strict-origin-when-cross-origin'
      - key: 'Permissions-Policy'
        value: 'geolocation=(), microphone=(), camera=()'
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.amazonaws.com https://*.amplify.aws"
